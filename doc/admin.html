<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
  <head>
    <title>OpenInteract Administrator's Guide</title>
  </head>

  <body>
    <h1>OpenInteract Administrator's Guide</h1>

<H1>Introduction</H1>

<P>
This document goes over issues concerning system administrators,
including mod_perl/Apache compilation and configuration, tips for
running multiple websites under one mod_perl server, package
configuration, logging, error reporting and caching.</p>

<p>While you're reading, it would be handy to have within reach the <a
href="glossary.html">OpenInteract Glossary</a> to lookup certain terms
(like 'website', 'handler', 'package', etc.).

<h1>oi_manage</h1>

<p>Distributed with OpenInteract is the script
<code>oi_manage</code>. If you installed OpenInteract via the normal
Perl mechanisms, you should have it in your
<code>/usr/local/bin</code> directory so it's always accessible. (You
might also ensure that <code>/usr/local/bin</code> is in your path and
your users' paths, or that you create a symlink from
<code>/usr/bin/oi_manage</code> to
<code>/usr/local/bin/oi_manage</code>.)</p>

<p>This script takes care of many actions for you. Here's a list and a
brief description of each:

<pre><font size="-1">
 install            - Install OpenInteract
 initial_packages   - List packages marked as 'initial'
 list_packages      - List packages installed to app or base
 create_skeleton    - Create a skeleton package for development
 export_package     - Export package(s) to distribution file(s)
 check_package      - Ensure that package passes initial inspection
 install_package    - Install package to the base
 create_website     - Create a new website
 test_db            - Test database settings in 'server.perl'
 apply_package      - Install a package from base to website
 remove_package     - Remove a package from a website
 upgrade_package    - Upgrade a website package
 install_sql        - Install the SQL for packages
 input_template     - Input package templates to the database
 dump_template      - Dump package templates to the filesystem
 remove_template    - Remove package templates from the database
</font></pre>

<p>You can read an <a href="oi_manage.html">online text version</a> of
the documentation for <code>oi_manage</code> For the most up-to-date
information, do a <code>perldoc oi_manage</code> from the command line
to view the extensive documentation.

<h1>OpenInteract</h1>

<p>This section reviews installation, layout and gives a very broad
overview of the packaging system.

<h2>Installation</h2>

<p>Installation of OpenInteract is very simple:

<pre><font size="-1">
 cd /path/where/I/unpacked/distribution
 oi_manage --base_dir=/path/to/install install
</font></pre>

<p>Easy! Read the <code>INSTALL</code> and
<code>INSTALL.website</code> files that were packaged with the
OpenInteract distribution for more details.

<h2>Layout</h2>

<p>OpenInteract is composed of two pieces: the installation and the
websites. The installation is what you create when you run the
<code>oi_manage</code> command above.

<p>And you refer to it when you create new websites:

<pre><font size="-1">
 oi_manage --base_dir=/path/to/install --website_dir=/path/to/website \
           --website_name=MySite create_website
</font></pre>

<p>Thereafter, the website keeps the information for the base
installation directory in its <code>conf/base.conf</code> file
described below. So you shouldn't need to refer to the installation
directory too often. (Developers need to know it when they are
developing packages, but that's a separate issue.)

<h2>Packages: Installing and Upgrading</h2>

<p>So OpenInteract exists in two parts: the installation and the
various websites that use the installation.  When users who run the
websites want to add new functionality by installing a new package or
upgrading an existing one, they must first add the package to the
OpenInteract installation and then apply it to the website.

<p>The OpenInteract installation maintains a copy of every version of
every package ever installed to the system. This might seem backwards,
but it ensures that different websites can use and continue to use
different versions of the same packages. This should allow you to
accommodate different types of users: bleeding-edge developers who
always play with new versions of packages and stay-the-line website
maintainers who just want everything to work the same day after day.

<p>Fortunately, the <code>oi_manage</code> script makes this whole
process easy for us:

<p><b>Install a new package to the installation:</b>

<pre><font size="-1">
 oi_manage --package_file=/path/to/file.tar.gz \
           --base_dir=/path/to/install install_package
</font></pre>

<p><b>Install a new version of an existing package to the installation:</b>

<pre><font size="-1">
 oi_manage --package_file=/path/to/file.tar.gz \
           --base_dir=/path/to/install install_package
</font></pre>

<p>Hey, those two were the same thing! It's true. Since the
installation maintains a copy of every version of every package, it
doesn't actually 'upgrade' a package in the installation. 

<p>This just emphasizes the main point: when you install a package to
the OpenInteract installation, you're simply making it available for
the websites that are using this installation.

<p><b>Apply an installed package to a website:</b>

<pre><font size="-1">
 oi_manage --package=newpackage --website_dir=/path/to/website \
           apply_package
</font></pre>

<p><b>Upgrade to a new version installed package for a website:</b>

<pre><font size="-1">
 oi_manage --package=newpackage --website_dir=/path/to/website \
           upgrade_package
</font></pre>

<p>Ah, now those two commands were different. This shows that a
website can only have <b>one version</b> of a particular package
installed. If you try to <code>apply_package</code> for a package that
has already been applied to a website, you'll get an error and no
action will be taken. In this case you need to use
<code>upgrade_package</code>.

<p>The docs for <code>oi_manage</code> discuss this next point but
it's worth repeating: when you use <code>upgrade_package</code>, you
merely update the registry information for the website. You also
install new data and structure, object configuration, templates,
handlers and everything else. 

<p>However, the system does <b>not</b> remove the old files. The
system does not know if you want to keep the changes you've made or
discard them, so it simply keeps the old directory around and allows
you to copy information back and forth as you need. But this old
directory is <b>not</b> used by the system anymore, and if you make
changes to files in the old package directory they will not be
reflected in the website.



<H1>Configuration File Formats</H1>
<P>
We generally use one of three formats. If you create new configuration
files, try to stick to these naming schemes.

<P>
<STRONG>.conf</STRONG>

<P>
Typical configuration file format: information separated into
key-value pairs (separated by whitespace), blank lines and lines that
begin with a comment (#) are skipped.

<P>
Example:

<P>
<PRE><FONT SIZE="-1">
  MyValue              emmet otter
  HerValue   fraggle rock
  TheirValue  jughandle
   # ringo   starr
</FONT></PRE>
<P>
Parsing this would return a hashref:

<PRE><FONT SIZE="-1"> { 
   MyValue    =&gt; 'emmet otter',
   HerValue   =&gt; 'fraggle rock',
   TheirValue =&gt; 'jughandle'
 }
</FONT></PRE>
<P>
<STRONG>.dat</STRONG>



<P>
Very simple: one item per line. Blank lines and lines beginning with a
comment (#) are skipped entirely.

<P>
Example:

<P>
<PRE><FONT SIZE="-1"> MyClass
 HerClass
 TheirClass
 #RingoClass
</FONT></PRE>
<P>
Parsing this would return an arrayref:

<PRE><FONT SIZE="-1"> 
  [ 'MyClass', 'HerClass', 'TheirClass' ]
</FONT></PRE>

<P>
<STRONG>.perl</STRONG>

<P>
This file is a full-fledged perl data structure, dumped to a file
using <code>Data::Dumper</code>. It can be any type of structure, but
it's normally used to represent a hashref containing all sorts of
different types of information. It's also fairly easy to edit such a
file using your favorite plain-text file editor.

<P>
When reading this type of configuration, we just return the data structure
saved in the file -- if the file is an arrayref, we return an arrayref.

<P>
When we use this structure to save information for objects (such as
the <code>OpenInteract::Config::PerlFile</code> object), we never save
class information about the object, just the data.  We can always
re-bless the structure after it's eval'd in.

<P>
Example:

<PRE><FONT SIZE="-1"> $data = {
          'db_info' =&gt; {
            'db_owner'    =&gt; '',
            'username'    =&gt; 'test',
            'password'    =&gt; '',
            'dsn'         =&gt; 'mydb',
            'db_name'     =&gt; 'myopeninteract',
            'driver_name' =&gt; 'mysql',
          },
          ...
 };
</FONT></PRE>

<H1>Website Configuration</H1>

<p>All files referenced in this section are contained in the home
directory of the website. For instance, if you install a website
using:

<pre><font size="-1">
 oi_manage --base_dir=/path/to/install --website_dir=/path/to/website \
           --website_name=MySite create_website
</font></pre>

<p>The files described here would be in <code>/path/to/website</code>.

<p><strong>File: conf/base.conf</strong>

<P>
This is one of the most important configuration files in
OpenInteract. This file allows <code>OpenInteract::Startup</code> to
bootstrap all the configuration information by supplying information
for the class that reads in the data for the server configuration
(<code>OpenInteract::Config::PerlFile</code> by default), the base
directory for this application, the name of the configuration
directory and file. You can also specify the Request class
(<code>OpenInteract::Request</code> by default) and a Stash class (no
default specified -- every application needs to have its own).

<P>
Example:

<PRE><FONT SIZE="-1">
base_dir         /opt/OpenInteract
website_dir      /home/httpd/mysite.com
website_name     MySite
config_class     OpenInteract::Config::PerlFile
config_dir       conf
config_file      server.perl
request_class    OpenInteract::Request
stash_class      MySite::Stash
</FONT></PRE>

<p>
<STRONG>File: conf/apache.dat</STRONG>

<P>
List the classes needed by mod_perl in the <CODE>Apache::</CODE>
class. The only ones you might need to change are
<code>Apache::StatINC</code> (shouldn't be used on production servers)
and <code>Apache::Session::MySQL</code> (you might require a different
session backing store).

<h1>Website Configuration</h1>

<p>
<strong>File: conf/server.perl</strong>

<p>
Website configuration is done through the <code>server.perl</code>
located in a website's <code>conf/</code> directory. When you create a
new website using <code>oi_manage</code> you get a starter
<code>server.perl</code> file with a number of items filled in. (View
the <a href="sample-server-perl.html">sample server.perl</a> file --
note that keys surrounded with '%%' will be replaced when you create a
website with <code>oi_manage</code>.

<p>This configuration is always available within the OpenInteract
environment (as an <code>OpenInteract::Config</code> object) to
developers and is read in anew every time the server starts.

<p>The file itself is formatted in Perl and you can edit it with your
favorite plain-text editor. You should be able to check whether it is
syntactically valid by doing:

<pre><font size="-1">
 perl -wc server.perl
</font></pre>

<p>This won't tell you whether it's <strong>functionally</strong>
valid, but it's a first step. Note that there is a routine in
<code>oi_manage</code> that allows you to check whether the parameters
defined in <code>server.perl</code> will allow a database connection
to be made:

<pre><font size="-1">
 oi_manage --website_dir=/path/to/my/website test_db
</font></pre>



<H1>Apache</H1>

<p>NOTE: DO NOT restart the Apache/mod_perl process using the
<tt>HUP</tt> signal. Your modules will not get reloaded properly.</p>

<h2>Proxy Setup</h2>

<p>OpenInteract depends on a persistent Perl environment within a web
server. Currently, the best alternative is <a href="http://perl.apache.org/">mod_perl</a>.

<p>mod_perl is extremely powerful, but this power can come at a
price. Embedding Perl into Apache uses more resources (particularly
memory) than just using Apache alone. A number of developers have
experimented with various ways of minimizing the memory footprint of
mod_perl, and one of the easiest and best performing methods is to use
a proxy server.

<p>This is described in great detail in the mod_perl guide under the
<a href="http://perl.apache.org/guide/strategy.html">Choosing the
Right Strategy</a> heading. But we'll summarize here:

<ol>

 <li>Setup a plain Apache server with mod_proxy and mod_rewrite to
 listen to port 80 for your website. (We describe the build process
 below.)

 <li>Tell this server to deal with static file requests (images,
 movies, PDFs, etc.)

 <li>Proxy all other requests back to a heavier mod_perl server.

 <li>Receive the information back from the mod_perl server and send to
 the client

</ol>

<p>The benefits of this are:

<ol>

 <li>Resource-hogging mod_perl processes do not serve static files --
 if they did, you'd need more of the processes.

 <li>The front-end proxy is able to feed data back to the client at
 whatever rate it needs without taking up many resources the entire
 time. For instance, users reaching your website with modems can tie
 up a web server process for much longer than users who are on some
 sort of broadband network. If the process is small it's not such a
 big deal.

 <li>Since they are separate, you can make changes to the (heavy)
 back-end and mask them by the (light) front-end. This is a great help
 when things are going wrong with the back-end and you don't want
 users to see nasty error pages.

 <li>Also since they are separate, you can very easily move the
 back-end process to an entirely separate machine (or machines, using
 some sort of DNS or load-balancing manipulation) if the need arises.

</ol>

<p>Running OpenInteract in this environment is <b>strongly</b>
recommended, and it comes with configuration files that make it easier
to do the Right Thing.

<H2>Building Apache: Proxy and mod_perl</H2>

<p>First, you need to get the <code>mod_proxy_add_forward</code>
module make available by Ask Bjoern Hansen. Retrieve it using
anonymous ftp at
<a href="ftp://ftp.netcetera.dk/pub/apache/mod_proxy_add_forward.c">ftp://ftp.netcetera.dk/pub/apache/mod_proxy_add_forward.c</a>.

<p>Once you've retrieved the file, copy it into the
<code>src/modules/extra</code> directory of your Apache source code
directory. An example of the 'activate-module' and 'enable-module'
directives to put this module into your Apache is below in the as well as in
the source code for <code>mod_proxy_add_forward</code> itself.

<p>Once you've retrieved the extra module and copied it to the right
place, you can create apache and mod_perl with the following
steps. Note that this assumes you have not installed apache from
source before and that you're installing to the directory
<code>/usr/local/apache</code> -- modify as needed.

<PRE><FONT SIZE="-1">
 1.  &gt;&gt; tar -zxvf apache-1.3.12.tar.gz

 2.  &gt;&gt; tar -zxvf mod_perl-1.24.tar.gz

 3.  &gt;&gt; cd apache-1.3.12

 4.  &gt;&gt; ./configure --prefix=/usr/local/apache \ 
                --enable-module=rewrite --enable_module=proxy \
                --activate-module=src/modules/extra/mod_proxy_add_forward.c \
                --enable-module=proxy_add_forward

 5.  &gt;&gt; make

 6.  &gt;&gt; make install
 (proxy server binary is now installed as /usr/local/apache/bin/httpd)

 7.  &gt;&gt; cd ../mod_perl-1.24

 8.  &gt;&gt; perl Makefile.PL EVERYTHING=1
 # Configure mod_perl with ../apache_1.3.12/src ? [y]

 9.  &gt;&gt; y
 # Shall I build httpd in ../apache_1.3.12/src for you? [y]

 10. &gt;&gt; y

 11. &gt;&gt; make

 12. &gt;&gt; make install
 (mod_perl Perl modules are now installed)

 13. &gt;&gt; cp ../apache-1.3.12/src/httpd /usr/local/apache/bin/httpd_mp
 (mod_perl-enabled Apache is now installed)

</FONT></PRE>

<P>
This is a very simple method for creating both a lightweight proxy
Apache binary and a heavyweight mod_perl-enabled Apache binary. See
the <a href="http://perl.apache.org/guide/"><EM>mod_perl
Guide</EM></a> for many, many more details about building mod_perl.

<P>
It is strongly recommended that you do <STRONG>not</STRONG> build
mod_perl using DSOs and that you do <STRONG>not</STRONG> use pre-built
versions such as those supplied by RedHat with its RPMs. However,
using the DSO mechanism probably works fine for the front-end proxy
server.

<h2>Configuration Overview</h2>

<p>Use <code>oi_manage</code>! Use <code>OI_MANAGE</code>! Use
<code><b>OI_MANAGE</b></code>!

<p>The <code>oi_manage</code> script included with OpenInteract
performs a number of tasks for you that make your life much
easier. When you run the <code>create_website</code> command along
with the appropriate parameters, <code>oi_manage</code> will copy
configuration files from the base installation to your website
directory and customize them for your website's parameters for
you. 

<p>For instance, two of the files that are copied to your website's
<code>conf/</code> directory are <code>httpd_static.conf</code> and
<code>httpd_modperl.conf</code>.  (See <a
href="sample-httpd-static.html">httpd_static.conf</a> and <a
href="sample-httpd-modperl.html">httpd_modperl.conf</a> -- the items
marked with '%%' are replaced in the customization process.) You will
still need to edit a few parameters in them -- <code>oi_manage</code>
is pretty smart, but it can't find out which IP address you want your
website to listen to! -- but much of it is filled in for you.

<h2>Static Apache Configuration</h2>

<p>After you've run <code>oi_manage</code>, you will need to modify a
few parameters in the static Apache configuration file.

<ol>
 <li><b>IP address</b>: Do a search-replace for '127.0.0.1' with the
 IP address you want the website to listen to. Note that if you're
 using named virtual hosts you will not want to keep the
 <code><a target="_blank" href="http://www.apache.org/docs/mod/core.html#listen">Listen</a></code> 
 directive. You will also need to specify the
 <code><a target="_blank" href="http://www.apache.org/docs/mod/core.html#namevirtualhost">NameVirtualHost</a></code> 
 directive in your main Apache configuration file.

 <li><b>ServerAdmin</b>: Change the value for the 'ServerAdmin' key

 <li><b>ServerName</b>: Change the value for the 'ServerName' key

</ol>

<p>Proxy configuration is fairly simple. Every rule (starting with
<code>RewriteRule</code>) is processed in order. Once a rule is met,
no further rules are processed unless the satisfied rule specifies it.

<p>The default proxy configuration assumes that the only static files
you will want to serve directly from the proxy server are images. This
action is specified by this line:

<pre><font size="-1">
 RewriteRule ^/images - [L]
</font></pre>

<p>If you want to add other locations that will be entirely served by
the lightweight server, just add them after this line. For example, if
my website had a directory '/forms' where we kept PDF versions of
forms for our customers to fill out, I could add:

<pre><font size="-1">
 RewriteRule ^/forms - [L]
</font></pre>

<p>And every URL beginning with <code>/forms</code> will be answered
by the front-end lightweight server. The <code>[L]</code> stands for
"Local" and means that you want this server (the proxy server) to
handle hte request.

<p>The only word of warning here is that as an administrator you might
need to keep an eye on what the back-end server is using for URLs. For
instance, say I entered this <code>/forms</code> configuration
directive and later a developer on the back-end server tries to
configure OpenInteract to perform a certain action when given the
<code>/forms</code> URL. Unless the developer knows that the front-end
server is answering all the <code>/forms</code> URLs, she will have a
very frustrating time trying to figure out why her handler isn't
responding.



<h2>mod_perl Configuration</h2>

<p>After you've run <code>oi_manage</code>, you will need to modify a
few parameters in the mod_perl Apache configuration file.

<ol>
 <li><b>IP address</b>: Do a search-replace for '127.0.0.1' with the
 IP address you want the website to listen to.
 <li><b>ServerAdmin</b>: Change the value for the 'ServerAdmin' key
 <li><b>ServerName</b>: Change the value for the 'ServerName' key
 <li><b>Port</b>: (optional) Do a search-replace for the default value
 of '8080' with whatever port you want to run the mod_perl server on
</ol>

<p><em>(Note: You can skip the remainder of this section if you just
want to get something up and running. The <code>oi_manage</code>
script takes care of all this for you. But if you're curious, read
on.)</em>

<P>
Four separate items need to be customized in the
<code>conf/httpd_modperl.conf</code> file

<P>
<b>First</b>, define the library paths for this website. Note that
this is applied on a server-wide basis, so be careful of namespace
clashes.

<P>
Example:

<P>
<PRE><FONT SIZE="-1">
 &lt;Perl&gt;
  use lib qw( /home/httpd/mysite.com );
 &lt;/Perl&gt;
</FONT></PRE>

<P>
<b>Second</b>, define a parameter that allow us to bootstrap our
configuration object which contains the rest of everything we need to
know.  The parameter is 'StashClass' you set it to a value that
OpenInteract can use for a website's stash class.

<P>
Example:

<PRE><FONT SIZE="-1">
 PerlSetVar StashClass      MySite::Stash
</FONT></PRE>

<P>
<b>Third</b>, you need to bring in your startup.pl. (Information on
what is done in the startup.pl is found in the <EM>OpenInteract
Developer's Guide</EM>.)

<pre><font size="-1">
 PerlRequire /home/httpd/mysite.com/conf/startup.pl
</font></pre>

<P>
<b>Fourth</b> and finally, we need to ensure that every request coming
in goes through a single Apache content handler:
<code>OpenInteract.pm</code>.  (This module is located in the
<CODE>base</CODE> package.) To enable this, just do:

<PRE><FONT SIZE="-1">
 &lt;Location /&gt; 
  SetHandler perl-script 
  PerlHandler OpenInteract
 &lt;/Location&gt;
</FONT></PRE>

<P>
This Apache content handler is in the <CODE>base</CODE> package since
it's part of the base functionality of the framework. We can just say
"OpenInteract" in the httpd.conf file because we have already included
the library in our <code>startup.pl</code>.


<H1>Running Multiple Websites on One Server</H1>

<P>
mod_perl is a fairly heavyweight server, and the <em>mod_perl Guide</em>
spends quite a few pages on different strategies you can use to minimize
the memory footprint. While the scenario of running one website per
server is appealing because it minimizes interaction between websites,
it might not be feasible due to your resources.

<P>
Fortunately, OpenInteract has taken pains to ensure that different
websites can run together using the same mod_perl-enabled apache
process family.

<p>The only trick currently is to ensure that websites do not use the
same namespace. It is best to make them as explicit as possible and
not use acronyms. This doesn't impose as much of a burden as it might
sound: developers rarely use fully qualified class names since
OpenInteract provides an aliasing facility for this sort of thing.

<P>
To run multiple websites under the same server, Every website must
have what is known as a <EM>stash class</EM>, or a package where
variables (such as the configuration object, the database handle, the
list of error handlers for website modules, and others) are fetched
during a request and kept intact between requests as well.

<P>
This allows us to do certain expensive operations once -- connect to a
database, establish a cache, create a template processing object, parse the
configuration file -- and keep the results for the lifetime of the apache
httpd child.

<p>Most of the time you'll never deal with the stash class -- the
<code>OpenInteract::Request</code> object saves and retrieves
information from it behind the scenes. In addition, when you create a
new website the <code>oi_manage</code> script creates a stash class
specifically for that website, and you don't need to do anything with
it to make it work.</p>



<h1>Suggested Readings</h1>

<ul>

 <li><b>mod_perl Guide</b><br> <A
 HREF="http://perl.apache.org/guide/">http://perl.apache.org/guide/</A></li>

 <li><b>General Apache documentation</b><br> <a
 href="http://www.apache.org/docs/">http://www.apache.org/docs/</a></li>

 <li><b>mod_rewrite manual</b><br> <a
 href="http://www.apache.org/docs/mod/mod_rewrite.html">http://www.apache.org/docs/mod/mod_rewrite.html</a></li>

 <li><b>Apache Virtual Host documentation</b><br> <a
 href="http://www.apache.org/docs/vhosts/index.html">http://www.apache.org/docs/vhosts/index.html</a></li>

</ul>

  </body>
</html>
  